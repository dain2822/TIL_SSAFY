## 251125

### [Objectives_ 학습 목표]

- Django view에서 JsonResponse를 반환하여 비동기 요청에 응답함
- data-* 속성을 사용해 Django 데이터를 JavaScript로 전달함
- Axios 요청 시 헤더에 CSRF 토큰을 포함하여 전송할 수 있음
- Axios를 활용해 팔로우 기능을 비동기적으로 구현할 수 있음
- 서버의 JSON 응답을 받아 DOM을 동적으로 업데이트함
- 버블링을 활용해 여러 요소의 이벤트를 효율적으로 관리함

---

### [Build_ 이론]

### [복습] Ajax(Asynchronous JavaScript and XML)와 서버

: 비동기적인 웹 애플리케이션 개발을 위한 기술

: Ajax는 웹 페이지 전체를 새로고침하지 않고, 백그라운드에서 서버와 데이터를 주고받는 비동기 통신 기술

: 구글 지도 앱을 움직여도 끊김이 없고, ‘좋아요’를 눌렀을 때 페이지만 부분적으로 바뀌는 것이 가능함

→ 웹 페이지를 데스크톱 애플리케이션처럼 동적이고 반응적으로 만들어주는 현대 웹의 핵심 기술 중 하나

**Ajax를 활용한 클라이언트 서버 간 동작**

: XHR 객체 생성 및 요청 → 응답 데이터 생성 → JSON 데이터 응답 → Promise 객체를 활용해 DOM 조작(웹 페이지의 일부분만을 다시 로딩)

![image.png](attachment:144673ff-7337-4c81-9cf6-ef970ad4517e:image.png)

### Ajax with follow

### 비동기 팔로우 구현

**사전 준비**

1. M : N 관계 모델링까지 진행된 Django 프로젝트 준비
2. 가상 환경 생성, 활성화 및 패키지 설치

**비동기 팔로우 구현_ Ajax 구현**

- 프로필 페이지에 axios CDN 작성
    
    ![image.png](attachment:70da8a69-1560-4c39-a8d3-5639b85d3f47:image.png)
    
- form 요소 선택을 위해 id 속성 지정 및 선택
- action과 method 속성은 삭제
    
    → 요청은 axios로 대체할 예정
    
    ![image.png](attachment:488a48c3-fcd4-4268-a693-9aacbea0882d:image.png)
    
- form 요소에 이벤트 핸들러 할당
- submit 이벤트의 기본 동작 취소하기
    
    ![image.png](attachment:2982c949-b290-452e-addb-22db42332b57:image.png)
    
- axios 요청 코드 작성
    - 요청 url에 필요한 사용자 pk는 어떻게 작성해야 할까?
    - CSRF 토큰은 어떻게 보내야 할까?
    
    ![image.png](attachment:da23cc7e-2124-4a5d-884f-31e0c034b7df:image.png)
    
- url에 작성할 user pk 가져오기(HTML ⇒ JavaScript)
    
    ![image.png](attachment:b5f74b0a-d3d7-4c98-89ae-3e2e700586f8:image.png)
    
    **’data-*’ 속성**
    
    : 사용자 지정 데이터 속성을 만들어, HTML과 DOM 사이에서의 임의의 데이터를 교환하는 방법
    
    : 모든 사용자 지정 데이터는 JavaScript에서 dataset 속성을 통해 접근
    
    - 주의 사항
        - 대소문자 여부에 상관없이 ‘xml’ 문자로 시작 불가
        - 세미콜론 포함 불가
        - 대문자 포함 불가
        
        ![image.png](attachment:bf8c188f-58aa-4425-8e72-d4f482059d05:image.png)
        
- 요청 url 작성 마무리
    
    ![image.png](attachment:3a6e8911-f38f-4d59-b1ee-f526e34af9c7:image.png)
    
- 문서상 input hidden 타입으로 존재하는 csrf token 데이터를 이제는 axios로 전송해야 함
    
    ![image.png](attachment:b6bb4f62-af1a-4d85-bc8d-ffba94e85c96:image.png)
    
    ![image.png](attachment:3b3f10a3-026e-46da-93a7-eac914abb0ec:image.png)
    
- 팔로우 버튼을 토글하기 위해서는 현재 팔로우 상태인지 언팔로우 상태인지에 대한 상태 확인이 필요
- Django의 view 함수에서 팔로우 여부를 나타내는 변수(is_followed)를 추가하여 JSON 형식으로 응답
- 팔로우 상태 여부를 JavaScript에게 전달할 데이터 작성
- 응답은 HTML 문서가 아닌 JSON 데이터로 응답하도록 변경(JsonResponse 활용)
    
    ![image.png](attachment:c7b720b5-fe01-4ba0-91b0-3e339a7397af:image.png)
    
- 팔로우 요청 후 Django 서버로부터 받은 응답 데이터 확인하기
    
    ![image.png](attachment:9ae0e46d-dbb5-4737-9f7a-fc4418472e14:image.png)
    
- 응답 데이터 is_followed에 따라 팔로우 버튼을 조작하기
    
    ![image.png](attachment:324eb20a-31af-4d64-8c20-cfa4a7f5f638:image.png)
    
- 클라이언트와 서버 간 XHR 객체를 주고 받는 것을 확인하기
- 개발자도구 - Network
    
    ![image.png](attachment:85aa6f03-d6d1-4f89-a438-1b9e29942b4d:image.png)
    
- “팔로잉 수와 팔로워 수 비동기 작용”
- Django view 함수에서 팔로워, 팔로잉 인원 수 연산을 진행하여 결과를 응답 데이터로 전달
    
    ![image.png](attachment:1c9375b7-f597-4396-84f3-bce58a322e1b:image.png)
    
- 해당 요소를 선택할 수 있도록 span 태그와 id 속성 작성
- 각 span 태그를 선택 후 응답 데이터를 받아 각 태그의 인원 수 값 변경에 활용
    
    ![image.png](attachment:983eed75-af64-47f3-bf15-008def5bc80d:image.png)
    

### Ajax with likes

### 비동기 좋아요 구현

**Ajax 좋아요 적용 시 유의사항**

- 전반적인 Ajax 적용 방식은 팔로우 구현 과정과 동일
- 하지만 팔로우와 달리 ‘좋아요’ 버튼은 한 페이지에 여러 개가 존재할 수 있음
- 모든 ‘좋아요’ 버튼에 각각 이벤트 리스너를 등록해야 할까?

![image.png](attachment:e1ddec77-7842-4aab-b019-80cce09dc5cc:image.png)

**[복습] 버블링(Bubbling)**

: 한 요소에 이벤트가 발생하면, 해당 요소의 핸들러가 동작한 후 이어서 부모 요소의 핸들러가 동작하는 현상

: 가장 최상단의 조상 요소(document)를 만날 때까지 이 과정이 반복되면서 요소 각각에 할당된 핸들러가 동작

![image.png](attachment:7379fadf-30a1-481a-ad1c-5dd792122986:image.png)

→ 최하위의 <p> 요소를 클릭하면 p → div → form 순서로 3개의 이벤트 핸들러가 모두 순차적으로 동작했던 것

**[복습] 버블링의 필요성**

: 만약 다음과 같이 각자 다른 동작을 수행하는 버튼이 여러 개 있다고 가정하면, 각 버튼마다 서로 다른 이벤트 핸들러를 등록해야 할까?

→ 각 버튼의 공통 조상인 div 요소에 이벤트 핸들러 단 하나만 할당하기

![image.png](attachment:1f8897b1-da12-44f7-8585-7ea2ca2c2aab:image.png)

: 요소들의 공통 조상에 이벤트 핸들러를 하나만 등록하면, 여러 자식 요소에서 발생하는 이벤트를 한 곳에서 효율적으로 다룰 수 있음

: 공통 조상(div)에 할당한 핸들러에서 event.target을 이용하면 실제 어떤 버튼에서 이벤트가 발생했는지 알 수 있기 때문

![image.png](attachment:943ca74b-e2d6-4f13-a5b8-5004caf35857:image.png)

**비동기 좋아요 구현_ Ajax 적용**

- 모든 좋아요 form 요소를 포함하는 최상위 요소 작성
    
    ![image.png](attachment:05908fe6-b9c4-4df2-b07f-763b1c938b29:image.png)
    
1. 최상위 요소 선택
2. 이벤트 핸들러 할당
3. 하위 요소에서 발생하는 submit 이벤트를 감지하고 form의 기본 제출 동작을 취소

![image.png](attachment:d4d40a15-d246-46d9-af95-d7265a90e074:image.png)

- axios 코드 작성
    
    → url 작성에 필요한 article pk는 어떻게 작성해야 할까?
    
    ![image.png](attachment:c8e62db3-91e1-40e6-8699-20f3584e5835:image.png)
    
- 각 form에 data-article-id=”{{ [article.pk](http://article.pk) }}”와 같이 data-* 속성을 부여하여, JavaScript에서 참조할 수 있도록 하기
    
    ![image.png](attachment:aac2070c-25dc-4597-b7bf-3746aa830022:image.png)
    

**[복습] 이벤트가 정확히 어디서 발생했는지 접근할 수 있는 방법**

1. event.currentTarget
    
    : ‘현재’ 요소
    
    : 항상 이벤트 핸들러가 연결된 요소만을 참조하는 속성
    
    : ‘this’와 같음
    
2. event.target
    
    : 이벤트가 발생한 가장 안쪽의 요소(target)를 참조하는 속성
    
    : 실제 이벤트가 시작된 요소
    
    : 버블링이 진행되어도 변하지 않음
    

- url 완성 후 요청 및 응답 확인
    
    ![image.png](attachment:1984e6c1-c252-4987-80b6-d6fc25f9e48d:image.png)
    
- 좋아요 버튼을 토글하기 위해서는 현재 사용자가 좋아요를 누른 상태인지 좋아요를 누르지 않은 상태인지에 대한 상태 확인이 필요
    
    → Django의 view 함수에서 좋아요 여부를 파악할 수 있는 변수 추가 생성
    
    → JSON 타입으로 응답하기
    
- 좋아요 상태 여부를 JavaScript에게 전달할 데이터 작성 및 JSON 데이터 응답
    
    ![image.png](attachment:41a91e1f-bb15-4226-b3e0-11851309d3ce:image.png)
    
- 응답 데이터 is_liked를 받아 isLike 변수에 할당
    
    ![image.png](attachment:0bb242d1-d591-4000-b1ae-7f8d34b0499e:image.png)
    
- isLiked에 따라 좋아요 버튼을 토글하기
    
    → 어떤 게시글의 ‘좋아요’ 버튼을 선택했는지 구별할 방법이 필요
    
    ![image.png](attachment:a951c196-37bd-48e1-af7c-0a5d78b4239e:image.png)
    
- 문자열과 [article.pk](http://article.pk) 값을 조합하여, 각 ‘좋아요’ 버튼(또는 관련 요소)에 고유한 id 속성을 부여
- 각 좋아요 버튼을 선택 후 isLiked에 따라 버튼을 토글
    
    ![image.png](attachment:dd69e1d1-b21f-4fbe-9ed8-38ba53baa684:image.png)
    

**비동기 좋아요 구현_ 버블링을 활용하지 않았다면?**

1. querySelectorAll()을 사용해 전체 좋아요 버튼을 선택
    - querySelectorAll() 선택을 위한 class 적용
    
    ![image.png](attachment:35676dba-b214-41f9-bc51-100cd7dc05a5:image.png)
    
2. forEach()를 사용해 전체 좋아요 버튼을 순회하면서 진행
    
    ![image.png](attachment:dce96135-98c8-48ad-8de4-f15c490c328f:image.png)
    